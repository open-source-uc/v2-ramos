---
import Layout from "@/layouts/Layout.astro";
import { getReportedReviews } from "@/services/admin.reviews";
import { MarkdownReviewView } from "@/components/reviews/MarkdownReviewView";
import { getToken } from "@/lib/auth";
import { getUserDataByToken } from "@/services/auth";
import { OsucPermissions } from "@/types/permissions";
import { actions, isInputError } from "astro:actions";
import { Button } from "@/components/ui/button";
import { Pill } from "@/components/ui/pill";
import {
    ThumbUpIcon,
    ThumbDownIcon,
    StarIcon,
    FlagIcon,
    CalendarIcon,
    WorkloadIcon,
    AttendanceIcon,
    EyeIcon,
    CloseIcon,
    HourglassIcon
} from "@/components/icons/icons";
import { formatWeeklyHours } from "@/lib/courseStats";

// Authentication check
const token = getToken(Astro.cookies);
if (!token) {
    return Astro.redirect("/");
}

const user = await getUserDataByToken(token);
if (!user || !user.permissions.includes(OsucPermissions.userIsRoot)) {
    return Astro.redirect("/");
}

const reportedReviews = await getReportedReviews(Astro.locals, token);

const result = Astro.getActionResult(actions.updateReviewStatus);
const successMessage = result?.data?.message;
---

<Layout>
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Header -->
        <section class="border border-border rounded-md px-6 py-8 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <Button
                            variant="ghost"
                            href="/admin"
                            size="sm"
                            className="text-muted-foreground hover:text-foreground"
                        >
                            ← Volver al Panel
                        </Button>
                    </div>
                    <h1 class="text-3xl font-bold mb-2">Reseñas Reportadas</h1>
                    <p class="text-muted-foreground">
                        Revisa las reseñas que han sido reportadas por la comunidad y toma las acciones necesarias
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <Pill variant="red" icon={FlagIcon}>
                        {reportedReviews.length} Reportadas
                    </Pill>
                </div>
            </div>
        </section>

        <!-- Success/Error Messages -->
        {successMessage && (
            <div class="mb-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-md">
                <p class="font-medium">{successMessage}</p>
            </div>
        )}
        {!isInputError(result?.error) && result?.error?.message && (
            <div class="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md">
                <p class="font-medium">{result.error.message}</p>
            </div>
        )}

        <!-- Reviews List -->
        {reportedReviews.length > 0 ? (
            <div class="space-y-6">
                {reportedReviews.map((review: any, index: number) => (
                    <div class="border border-red-200 rounded-md overflow-hidden bg-red-50/30" id={review.id + "-reported"}>
                        <!-- Review Header -->
                        <div class="border-b border-red-200 px-6 py-4 bg-red-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-sm font-bold">
                                        {index + 1}
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold">{review.course_sigle}</h3>
                                        <p class="text-sm text-muted-foreground">
                                            Reportada: {new Date(review.updated_at).toLocaleDateString('es-CL', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="flex gap-2 items-center p-2 bg-red-100 text-red-600 border border-red-200 rounded-lg">
                                        <FlagIcon className="h-5 w-5 fill-current" />
                                        <span class="text-sm font-semibold">Reportada</span>
                                    </div>
                                    <div class={`flex gap-2 items-center p-2 border rounded-lg ${
                                        review.like_dislike === 2
                                            ? "bg-green-light text-green border-green/20"
                                            : review.like_dislike === 1
                                            ? "bg-blue-light text-blue border-blue/20" 
                                            : "bg-red-light text-red border-red/20"
                                    }`}>
                                        {review.like_dislike === 2 ? (
                                            <StarIcon className="h-5 w-5 fill-current" />
                                        ) : review.like_dislike === 1 ? (
                                            <ThumbUpIcon className="h-5 w-5 fill-current" />
                                        ) : (
                                            <ThumbDownIcon className="h-5 w-5 fill-current" />
                                        )}
                                        <span class="text-sm font-semibold">
                                            {review.like_dislike === 2
                                                ? "Super Recomendación"
                                                : review.like_dislike === 1
                                                  ? "Recomendación"
                                                  : "No Recomendación"}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Review Content -->
                        <div class="p-6 bg-white">
                            <!-- Alert Notice -->
                            <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <FlagIcon className="h-5 w-5 text-amber-600 fill-current" />
                                    <p class="text-sm text-amber-800 font-medium">
                                        Esta reseña ha sido reportada por la comunidad. Revisa el contenido cuidadosamente antes de tomar una decisión.
                                    </p>
                                </div>
                            </div>

                            {review.comment_path && (
                                <div class="mb-6">
                                    <MarkdownReviewView
                                        path={review.comment_path}
                                        client:only="react"
                                    />
                                </div>
                            )}

                            <!-- Review Metadata -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                <Pill variant="ghost_green" size="sm" icon={CalendarIcon}>
                                    {review.year_taken} - {review.semester_taken === 1 ? "1er" : "2do"} sem
                                </Pill>
                                <Pill variant="ghost_blue" size="sm" icon={WorkloadIcon}>
                                    {review.workload_vote === 0
                                        ? "Carga Baja"
                                        : review.workload_vote === 1
                                        ? "Carga Media"
                                        : "Carga Alta"}
                                </Pill>
                                <Pill variant="ghost_purple" size="sm" icon={AttendanceIcon}>
                                    {review.attendance_type === 0
                                        ? "Asistencia Obligatoria"
                                        : review.attendance_type === 1
                                        ? "Asistencia Opcional"
                                        : "Sin Asistencia"}
                                </Pill>
                                {review.weekly_hours && (
                                    <Pill variant="ghost_orange" size="sm" icon={HourglassIcon}>
                                        {formatWeeklyHours(review.weekly_hours)}/sem
                                    </Pill>
                                )}
                            </div>

                            <!-- Action Form -->
                            <form method="post" action={actions.updateReviewStatus} class="border border-red-200 rounded-lg p-4 bg-red-50">
                                <input type="hidden" name="review_id" value={review.id} />
                                
                                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-end">
                                    <div class="flex-1">
                                        <label for={`status-${review.id}`} class="block text-sm font-medium text-foreground mb-2">
                                            Decisión sobre la reseña reportada
                                        </label>
                                        <select
                                            id={`status-${review.id}`}
                                            name="status"
                                            required
                                            class="w-full border border-border rounded-md px-3 py-2 bg-background text-foreground text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                        >
                                            <option value="" disabled selected>
                                                Seleccionar acción
                                            </option>
                                            <option value="1">✅ Mantener reseña (reporte infundado)</option>
                                            <option value="3">❌ Ocultar reseña (reporte válido)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex gap-2">
                                        <Button
                                            type="submit"
                                            variant="destructive"
                                            size="sm"
                                        >
                                            Aplicar Decisión
                                        </Button>
                                        <Button
                                            variant="outline"
                                            href={`/${review.course_sigle}`}
                                            size="sm"
                                            icon={EyeIcon}
                                        >
                                            Ver Curso
                                        </Button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <!-- Empty State -->
            <div class="border border-border rounded-md p-12 text-center">
                <div class="w-16 h-16 bg-green-light text-green rounded-full flex items-center justify-center mx-auto mb-4">
                    <ThumbUpIcon className="h-8 w-8 fill-current" />
                </div>
                <h3 class="text-lg font-semibold mb-2">¡Excelente!</h3>
                <p class="text-muted-foreground mb-6">
                    No hay reseñas reportadas en este momento. La comunidad está funcionando bien.
                </p>
                <Button variant="outline" href="/admin">
                    Volver al Panel de Administración
                </Button>
            </div>
        )}
    </div>
</Layout>
