---
import Layout from '@/layouts/Layout.astro'
import ContentHeader from '@/components/features/article/HeaderContent.astro'
import { getToken } from '@/lib/auth'
import config from '@/lib/const'
import { getUserDataByToken } from '@/lib/server/auth'
import { createSlug } from '@/lib/utils'
import type { Recommendations } from '@/types'
import { OsucPermissions } from '@/types/permissions'
import { actions } from 'astro:actions'
import BlogBasicInfo from '@/components/features/article/BlogBasicInfo.astro'
import EditorMDX from '@/components/EditorMDX'
import RecommendationBasicInfo from '@/components/features/article/RecommendationBasicInfo.astro'
import { record } from 'astro:schema'

export const prerender = false

// Obtener parámetros de la URL
const recommendationId = Astro.params.id

const token = getToken(Astro.cookies)
const user = await getUserDataByToken(token)
if (!user) {
  Astro.redirect('/')
}

const recommendationResponse = await fetch(`${config.BASEURL}/api/articles/recommendationById?id=${recommendationId}`)
const recommendationJson = (await recommendationResponse.json()) as unknown as Recommendations[]
const recommendationData: Recommendations = recommendationJson[0]
if (!recommendationData) {
  throw new Error('No se encontró la recomendación solicitada.')
}

if (
  (user && (String(user.id) !== String(recommendationData.user_id))) ||
  !user?.permissions?.includes(OsucPermissions.userCanCreateBlogs)
) {
  Astro.redirect(`/recommendations/${createSlug(recommendationData.organization_name)}/${createSlug(recommendationData.title)}`)
}
let message = ''
let messageType = ''

// Verificar si hay un resultado de la acción
const result = Astro.getActionResult(actions.updateRecommendation)

if (result && !result.error) {
  message = result.data?.message || 'Recomendación actualizado exitosamente';
  messageType = 'success';
}
else if (result?.error) {
  message = result.error.message || 'Error al actualizar el recomendación';
  messageType = 'error';
}

const mdxContent = await fetch(`${config.BASEURL}/api/articles/article?path=${recommendationData.content_path}`)
	.then(res => res.text())
	.catch(() => '');
---


<Layout title={`Edita: ${recommendationData.title}`}> 
	<main class="mx-auto w-full max-w-7xl px-4 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
	<!-- Estado del formulario -->
	{message && (
		<section
			class={`mb-6 rounded-md border p-4 sm:p-6 ${
				messageType === 'success' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
			}`}
			role="alert"
			aria-live="polite"
		>
			<div class="flex items-center gap-2">
				<span
					class={`flex-shrink-0 ${
						messageType === 'success' ? 'text-green-600' : 'text-red-600'
					}`}
				>
					{messageType === 'success' ? '✅' : '❌'}
				</span>
				<p
					class={`text-xs font-medium sm:text-sm ${
						messageType === 'success' ? 'text-green-800' : 'text-red-800'
					}`}
				>
					{message}
				</p>
			</div>
		</section>
	)}
	<div class="mb-6">
		<a href={`/recommendations/${createSlug(recommendationData.organization_name)}/${createSlug(recommendationData.title)}`} class="text-blue-500 ver:underline">{`<-`} Volver a la recomendación</a>
	</div>
		<!-- Header Section -->
		<ContentHeader
			headerTitle="Edita tu recomendación"
			headerSubtitle="Edita el contenido de tu recomendación y compártelo con la comunidad"
		/>

		<!-- Formulario Principal -->
		<section aria-labelledby="form-title">
			<article class="border-border min-w-0 rounded-md border">
				<div class="p-4 sm:p-6 lg:p-8">
					<h2 id="form-title" class="mb-4 text-lg font-semibold sm:mb-6 sm:text-xl">
						Información del blog
					</h2>

					<form class="min-w-0 space-y-4 sm:space-y-6" method="POST" action={actions.updateRecommendation}>
						<!-- Información básica del blog -->
						 <RecommendationBasicInfo title={recommendationData.title} user={user} organization_id={String(recommendationData.organization_id)} organization_name={recommendationData.organization_name} code={recommendationData.code} period_time={recommendationData.period_time} qualification={recommendationData.qualification} readtime={recommendationData.readtime} />
						<input type="number" value={recommendationData.id} name="id" hidden />
						<!-- Separador -->
						<div class="border-border border-t pt-4 sm:pt-6">
							<div class="mb-4 space-y-2">
								<label class="text-foreground block text-sm font-medium">
									Contenido del blog <span class="text-red-500">*</span>
								</label>
								<p class="text-muted-foreground text-xs sm:text-sm">
									Utiliza el editor para crear contenido enriquecido con formato, imágenes y
									componentes especiales.
								</p>
							</div>
						</div>

						<!-- Editor MDX -->
						<div class="min-w-0">
							<EditorMDX initialContent={mdxContent} submitText="Actualizar Recomendación" client:only="react" />
						</div>
					</form>
				</div>
			</article>
		</section>
	</main>
</Layout>