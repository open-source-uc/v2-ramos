---
import { getCollection } from 'astro:content'
import BlogsScroll from '@/components/features/blog/BlogsScroll.tsx'
import Layout from '@/layouts/Layout.astro'
import { MarkdownReviewView } from '@/components/reviews/MarkdownReviewView.tsx'
import BlogCard from '@/components/features/blog/BlogCard.tsx'
import { Pill } from '@/components/ui/pill'
import { BuildingIcon, InstagramIcon, GitHubIcon, LinkedInIcon } from '@/components/icons/icons'
import config from '@/lib/const'
export const prerender = true

export async function getStaticPaths() {
	const organizations = await getCollection('organizations')
	return organizations.map((organization) => ({
		params: {
			name: organization.data.name.toLowerCase().replace(/\s+/g, '-'),
		},
		props: { organization },
	}))
}

const { organization } = Astro.props
const { title, name, picture, faculty, rrss } = organization.data
const { Content } = await organization.render()

// Obtener blogs desde la API (R2/BD)
let blogs: any[] = []
try {
	// La API actual no filtra por organización, así que filtramos en el cliente
	const res = await fetch(new URL(`/api/blogs`, config.BASEURL))
	if (res.ok) {
		const allBlogs = (await res.json()) as any[]
		blogs = allBlogs.filter((blog) => blog.organization_name === name)
	}
} catch (e) {
	blogs = []
}
---

<Layout>
	<main class="mx-auto max-w-7xl px-4 py-8">
		<!-- Hero Section -->
		<a
			class="mb-4 inline-flex items-center gap-2 text-blue-600 transition-colors hover:text-blue-800 hover:underline"
			href={`/organizations`}
		>
			← Ver más organizaciones
		</a>
		<header class="mb-12">
			<section class="border-border rounded-md border p-8" aria-labelledby="initiative-title">
				<div class="flex flex-col items-start gap-6 lg:flex-row lg:items-center">
					<div class="flex-1">
						<div class="mb-4">
							<Pill size="sm" variant="blue" icon={BuildingIcon}>
								{faculty}
							</Pill>
						</div>
						<h1 id="organization-title" class="text-foreground mb-2 text-4xl font-bold lg:text-5xl">
							{name}
						</h1>
						<p class="text-muted-foreground text-lg">{title}</p>
					</div>
					<aside class="flex-shrink-0">
						<figure
							class="border-border h-24 w-24 overflow-hidden rounded-md border bg-white p-4 lg:h-32 lg:w-32"
						>
							<img
								src={picture}
								alt={`Logo de ${name}`}
								class="h-full w-full object-contain"
								loading="eager"
							/>
						</figure>
					</aside>
				</div>
			</section>
		</header>
		<!-- Main Content -->
		<div class="grid gap-8 lg:grid-cols-3">
			<!-- Initiative Description -->
			<section class="lg:col-span-2" aria-labelledby="description-title">
				<article class="border-border overflow-hidden rounded-md border">
					<div class="p-8">
						<h2 id="description-title" class="text-xl font-semibold">
							Descripción de la organización
						</h2>
						<div class="content-markdown">
							<Content />
						</div>
					</div>
				</article>
			</section>

			<!-- Sidebar -->
			<aside class="space-y-8" aria-label="Información adicional">
				<!-- Social Media Links (if available) -->
				<!-- Blogs Section -->
				<section class="border-border rounded-md border p-6" aria-labelledby="blogs-title">
					<header class="mb-4">
						<h3 id="blogs-title" class="text-foreground text-lg font-semibold">
							Blogs relacionados
							{
								blogs.length > 0 && (
									<Pill size="sm" variant="green" className="ml-2">
										{blogs.length}
									</Pill>
								)
							}
						</h3>
					</header>
					{
						blogs.length > 0 ? (
							<div role="region" aria-label="Lista de blogs relacionados">
								<BlogsScroll blogs={blogs} />
							</div>
						) : (
							<div class="py-8 text-center" role="status" aria-live="polite">
								<p class="text-muted-foreground text-sm">
									No hay blogs disponibles para esta organización
								</p>
							</div>
						)
					}
				</section>
				{
					rrss && Object.keys(rrss).length > 0 && (
						<section class="border-border rounded-md border p-6" aria-labelledby="social-title">
							<h3 id="social-title" class="text-foreground mb-4 text-lg font-semibold">
								Síguenos
							</h3>
							<nav aria-label="Enlaces de redes sociales">
								<ul class="space-y-3" role="list">
									{rrss.instagram && (
										<li>
											<a
												href={rrss.instagram}
												target="_blank"
												rel="noopener noreferrer"
												class="border-border hover:bg-accent focus:ring-ring flex items-center gap-3 rounded-lg border p-3 transition-colors focus:ring-2 focus:ring-offset-2 focus:outline-none"
												aria-label={`Seguir a ${name} en Instagram`}
											>
												{' '}
												<div
													class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-pink-500"
													aria-hidden="true"
												>
													<InstagramIcon className="w-4 h-4 text-white" />
												</div>
												<span class="text-muted-foreground text-sm">Instagram</span>
											</a>
										</li>
									)}
									{rrss.github && (
										<li>
											<a
												href={rrss.github}
												target="_blank"
												rel="noopener noreferrer"
												class="border-border hover:bg-accent focus:ring-ring flex items-center gap-3 rounded-lg border p-3 transition-colors focus:ring-2 focus:ring-offset-2 focus:outline-none"
												aria-label={`Ver repositorios de ${name} en GitHub`}
											>
												{' '}
												<div
													class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-900"
													aria-hidden="true"
												>
													<GitHubIcon className="w-4 h-4 text-white" />
												</div>
												<span class="text-muted-foreground text-sm">GitHub</span>
											</a>
										</li>
									)}
									{rrss.linkedin && (
										<li>
											<a
												href={rrss.linkedin}
												target="_blank"
												rel="noopener noreferrer"
												class="border-border hover:bg-accent focus:ring-ring flex items-center gap-3 rounded-lg border p-3 transition-colors focus:ring-2 focus:ring-offset-2 focus:outline-none"
												aria-label={`Conectar con ${name} en LinkedIn`}
											>
												{' '}
												<div
													class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-600"
													aria-hidden="true"
												>
													<LinkedInIcon className="w-4 h-4 text-white" />
												</div>
												<span class="text-muted-foreground text-sm">LinkedIn</span>
											</a>
										</li>
									)}
								</ul>
							</nav>
						</section>
					)
				}
			</aside>
		</div>
	</main>
</Layout>
