---
import ContentPage from "@/components/common/ContentPage.astro";
import { EditIcon, ClockIcon } from "@/components/icons/icons";
import Layout from "@/layouts/Layout.astro";
import { createSlug } from "@/lib/utils";
import type { Blogs, Organization } from "@/types";
import { MarkdownReviewView } from "@/components";

export const prerender = true;

export async function getStaticPaths() {
  const response = await fetch("http://localhost:4321/api/blogs");
  const blogs: Blogs[] = await response.json();
  return blogs.map((blog) => ({
    params: {
      author: createSlug(blog.organization_name),
      title: createSlug(blog.title),
    },
    props: { blog },
  }));
}

const { blog } = Astro.props;
const userOrgRes = await fetch(
  `http://localhost:4322/api/user/${blog.user_id}`
);

const organizationRes = await fetch(
  `http://localhost:4322/api/organization/${blog.organization_id}`
);
const organizationData = (await organizationRes.json()) as Organization;
const mdxContent = fetch(
  new URL(`/api/blog?path=${blog.content_path}`, Astro.url.origin)
)
  .then(async (res) => {
    if (!res.ok) throw new Error("Failed to fetch MDX content");
    const content = await res.text();
    return content;
  })
  .catch((error) => {
    console.error("Error fetching MDX content:", error);
    return ""; // Return empty content on error
  });
---

<Layout>
  <ContentPage
    contentData={blog}
    organizationData={organizationData}
    contentType="blog"
    primaryPillIcon={EditIcon}
    secondaryPillIcon={ClockIcon}
    navigationSection={{
      title: "¿Te gustó este blog?",
      description:
        "Descubre más contenido interesante en los blogs que tenemos para ofrecerte.",
      buttonText: "Ver Más Blogs",
      buttonHref: "/blogs",
    }}
  >
    <MarkdownReviewView path={blog.content_path} client:load />
  </ContentPage>
</Layout>
